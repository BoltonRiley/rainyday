<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rainy Day RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    overflow: hidden;
    color: white;
    font-family: sans-serif;
    background: black;
}
.hidden { display: none; }

#bgvideo {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
}

#soundToggle {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 16px;
    background: rgba(0,0,0,0.6);
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 16px;
    cursor: pointer;
    z-index: 10;
}

section {
    padding: 20px;
    text-align: center;
}

#gameCanvas {
    background: #111;
    border: 2px solid #555;
    image-rendering: pixelated;
}

#optionDisplay {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0,0,0,0.6);
    padding: 6px 10px;
    border-radius: 6px;
    font-weight: bold;
}
</style>
</head>

<body>

<!-- BACKGROUND MEDIA -->
<video id="bgvideo" autoplay muted loop playsinline>
    <source src="assets/video.mp4" type="video/mp4">
</video>

<audio id="bgaudio" loop>
    <source src="assets/audio.mp3" type="audio/mp3">
</audio>

<button id="soundToggle">ðŸ”‡ Sound Off</button>

<div id="optionDisplay" class="hidden">Option: None</div>

<!-- WEATHER / ENTRY GATE -->
<section id="weatherGate">
    <h1>Rainy Day RPG</h1>
    <p id="output">Checking weatherâ€¦</p>
    <button onclick="startGame()">Enter Anyway (Dev)</button>
</section>

<!-- CHARACTER BUILDER -->
<section id="characterBuilder" class="hidden">
    <h2>Character Builder</h2>
    <p>This will be expanded later.</p>
    <button onclick="startGame()">Start Game</button>
</section>

<!-- MAIN GAME -->
<section id="gameSection" class="hidden">
    <canvas id="gameCanvas" width="640" height="640"></canvas>
    <p>Move: WASD / Arrow Keys â€” Interact: E</p>
</section>

<!-- CHAPTER END -->
<section id="chapterEnd" class="hidden">
    <h1>Chapter Complete</h1>
    <p>You step through the threshold. The rain changes.</p>

    <h3>Pick an option:</h3>
    <button onclick="selectOption('left')">Left</button>
    <button onclick="selectOption('middle')">Middle</button>
    <button onclick="selectOption('right')">Right</button>

    <h3>Save Code:</h3>
    <textarea id="saveOutput" style="width:90%; height:60px;" readonly></textarea>
</section>

<!-- AUDIO LOGIC -->
<script>
const audio = document.getElementById("bgaudio");
const soundBtn = document.getElementById("soundToggle");
let soundOn = false;
soundBtn.onclick = () => {
    soundOn = !soundOn;
    if (soundOn) { audio.play(); soundBtn.textContent = "ðŸ”Š Sound On"; }
    else { audio.pause(); soundBtn.textContent = "ðŸ”‡ Sound Off"; }
};
</script>

<!-- SECTION CONTROL -->
<script>
function startGame() {
    window.location.href = "RainDay.html";
}
</script>

<!-- GAME LOOP -->
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const TILE = 40;
const MAP_SIZE = 16;

// 0 = floor, 1 = wall, 2 = interactable, 3 = exit
const map = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,1],
  [1,0,1,1,1,0,1,1,1,0,0,1,1,1,0,1],
  [1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1],
  [1,0,1,0,1,1,1,0,1,1,1,1,0,1,0,1],
  [1,0,1,0,0,0,0,0,0,0,0,1,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,1,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,0,1,0,0,0,1,0,1],
  [1,1,1,1,1,1,1,1,0,1,1,1,0,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,1,0,1,1,1,0,1],
  [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1],
  [1,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1],
  [1,0,2,0,0,0,0,0,0,1,0,0,0,0,3,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const unlocked = new Set();
const player = { x: 1, y: 1 };
let currentChapter = 1;
const optionDisplay = document.getElementById("optionDisplay");

// DRAW MAP
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for (let y=0; y<MAP_SIZE; y++) {
        for (let x=0; x<MAP_SIZE; x++) {
            const tile = map[y][x];
            if (tile === 1) ctx.fillStyle="#444";
            else if (tile === 2) ctx.fillStyle = unlocked.has(`${x},${y}`) ? "lime" : "red";
            else if (tile === 3) ctx.fillStyle="gold";
            else ctx.fillStyle="#222";
            ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
        }
    }
    ctx.fillStyle="cyan";
    ctx.fillRect(player.x*TILE+8, player.y*TILE+8, 24,24);
}

// COLLISION
function canMove(x,y) { return map[y]?.[x] !==1; }

// INPUT
window.addEventListener("keydown", e=>{
    let nx=player.x, ny=player.y;
    if(e.key==="ArrowUp"||e.key==="w") ny--;
    if(e.key==="ArrowDown"||e.key==="s") ny++;
    if(e.key==="ArrowLeft"||e.key==="a") nx--;
    if(e.key==="ArrowRight"||e.key==="d") nx++;

    if(canMove(nx,ny)){ player.x=nx; player.y=ny; }

    // Interact
    if(e.key.toLowerCase()==="e"){
        const key=`${player.x},${player.y}`;
        if(map[player.y][player.x]===2){
            unlocked.has(key)?unlocked.delete(key):unlocked.add(key);
        }
    }

    // Chapter exit
    if(map[player.y][player.x]===3){
        endChapter();
        return;
    }

    draw();
});

draw();

// GAME SAVE
let gameSave = { chapter:1, unlocked:new Set(), choices:{} };

function endChapter(){
    document.getElementById("gameSection").classList.add("hidden");
    document.getElementById("chapterEnd").classList.remove("hidden");
    gameSave.chapter = currentChapter;
    gameSave.unlocked = new Set(unlocked);
    updateSaveCode();
}

function updateSaveCode(){
    const saveData = {
        chapter: gameSave.chapter,
        unlocked: Array.from(gameSave.unlocked),
        choices: gameSave.choices
    };
    document.getElementById("saveOutput").value = btoa(JSON.stringify(saveData));
}

function selectOption(option){
    gameSave.choices[currentChapter] = option;
    optionDisplay.classList.remove("hidden");
    optionDisplay.textContent = "Option: "+option;
    currentChapter++;
    document.getElementById("chapterEnd").classList.add("hidden");
    document.getElementById("gameSection").classList.remove("hidden");
    // Reset player for now
    player.x=1; player.y=1;
    draw();
}

// LOAD SAVE
function loadSave(code){
    try{
        const data = JSON.parse(atob(code));
        currentChapter = data.chapter;
        unlocked.clear();
        data.unlocked.forEach(k=>unlocked.add(k));
        gameSave.choices = data.choices;
        startGame();
        draw();
    }catch(e){ alert("Invalid save code"); }
}
</script>

</body>
</html>
